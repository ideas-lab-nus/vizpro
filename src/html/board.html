{% load static %}
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta http-equiv="X-UA-Compatible" content="ie=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />

        <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
        <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
        <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

        <script src="https://d3js.org/d3-path.v1.min.js"></script>
        <script src="https://d3js.org/d3-shape.v1.min.js"></script>
        <script src="https://d3js.org/d3.v5.min.js"></script>

        <link
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.css"
            rel="stylesheet"
        />
        <!--load all styles -->
        <link href="{% static '/base/css/gray_style.css' %}" rel="stylesheet" />
        <link href="{% static '/base/css/jsonview.css' %}" rel="stylesheet" />

        <!-- 
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
     -->
        <title>{{def.definition_name}}</title>
    </head>
    <body>
        <style>
            body {
                background-color: #eeeeee;
            }

            div#group_division_container {
                border: 1px solid #e0e0e0;
                border-radius: 2px;
                padding: 2px;
                background-color: white;
                box-shadow: 0px 0px 3px #d9d9d9;
                margin: 2px;
            }

            div#componentBox {
                border-radius: 5px;
                color: white;
                padding: 4px;
                font-family: monospace;
                font-size: small;
                font-weight: bold;
            }

            div#boardgroupControlPanel {
                text-align: center;
                border-bottom: 1px solid gray;
                padding: 4px;
            }

            textarea.boardgroup_textarea {
                width: 97%;
                font-family: 'ubuntu mono';
                color: gray;
                font-size: small;
                border: 1px solid #515151;
                border-radius: 0px;
                resize: none;
            }
            div#arrowDown {
                text-align: center;
                padding: 6px 0px;
            }
            div#group_division {
                max-width: 500px;
                margin: auto;
            }

            div.input-group-text {
                background-color: #424242;
                color: white;
                font-size: small;
                font-weight: bold;
                padding: 2px 9px;
                display: inline;
                font-family: 'ubuntu mono';
                border-radius: 6px 6px 0px 1px;
            }
        </style>
        <h1>{{def.definition_name}}</h1>
        <hr />
        <div class="container-fluid"></div>

        <script>
            allComp=[]
                RetrievedData = {{ def.definition_user_saved|safe }};


                if (RetrievedData.components != undefined) {
            allComp = RetrievedData.components;
                }
        </script>
        <script src="{% static '/base/js/functions.js' %}"></script>

        <script>
            function drawPlotBoardComponent(data, comp) {
                if (data != null && Array.isArray(data)) {
                    if (data[0].type == 'scatter') {
                        if ('layout' in data[0]) {
                            Plotly.newPlot('plot_area' + comp.GUID, data[0].data, data[0].layout, {
                                responsive: true
                            });
                        } else {
                            Plotly.newPlot('plot_area' + comp.GUID, data[0].data, {
                                responsive: true
                            });
                        }
                    } else if (data[0].type == 'bar') {
                        data[0].data.forEach(dataElement => {
                            maxValue = Math.max(...dataElement.y);
                            dataElement['marker'] = { color: [] };
                            dataElement.y.forEach(dataValue => {
                                dataElement.marker.color.push(
                                    d3.interpolateGnBu(dataValue / maxValue)
                                );
                            });
                        });
                        if ('layout' in data[0]) {
                            Plotly.newPlot('plot_area' + comp.GUID, data[0].data, data[0].layout, {
                                responsive: true
                            });
                        } else {
                            Plotly.newPlot('plot_area' + comp.GUID, data[0].data, {
                                responsive: true
                            });
                        }
                    } else {
                        if ('layout' in data[0]) {
                            Plotly.newPlot('plot_area' + comp.GUID, data[0].data, data.layout, {
                                responsive: true
                            });
                        } else {
                            Plotly.newPlot('plot_area' + comp.GUID, data[0].data, {
                                responsive: true
                            });
                        }
                    }
                } else if (data != null) {
                    if (data.type == 'scatter') {
                        if ('layout' in data) {
                            Plotly.newPlot('plot_area' + comp.GUID, data.data, data.layout, {
                                responsive: true
                            });
                        } else {
                            Plotly.newPlot('plot_area' + comp.GUID, data.data, {
                                responsive: true
                            });
                        }
                    } else if (data.type == 'bar') {
                        data.data.forEach(dataElement => {
                            maxValue = Math.max(...dataElement.y);
                            dataElement['marker'] = { color: [] };
                            dataElement.y.forEach(dataValue => {
                                dataElement.marker.color.push(
                                    d3.interpolateGnBu(dataValue / maxValue)
                                );
                            });
                        });
                        if ('layout' in data) {
                            Plotly.newPlot('plot_area' + comp.GUID, data.data, data.layout, {
                                responsive: true
                            });
                        } else {
                            Plotly.newPlot('plot_area' + comp.GUID, data.data, {
                                responsive: true
                            });
                        }
                    } else {
                        if ('layout' in data) {
                            Plotly.newPlot('plot_area' + comp.GUID, data.data, data.layout, {
                                responsive: true
                            });
                        } else {
                            Plotly.newPlot('plot_area' + comp.GUID, data.data, {
                                responsive: true
                            });
                        }
                    }
                } else {
                    Plotly.newPlot(
                        'plot_area' + comp.GUID,
                        [{ x: ['1', '2', '3'], y: [1.0, 2.0, 3.0], type: 'bar' }],
                        { title: 'Dummy plot' },
                        { responsive: true }
                    );
                }
            } // End of drawPlotComponent
        </script>

        <script>
            // Get the grouped definitons

            var allGroups = { 0: [] };
            var instGroupIndx = 0;
            var instIndex = 0;
            var tempGroup = [];

            var chain = [];
            function getChildrenChain(compid) {
                if (RetrievedData.parent_child_matrix[compid].length > 0) {
                    RetrievedData.parent_child_matrix[compid].forEach(child => {
                        console.log(child[1]);
                        if (!chain.includes(compid)) {
                            if (allGroups[instGroupIndx] == undefined) {
                                allGroups[instGroupIndx] = [compid];
                            } else {
                                allGroups[instGroupIndx].push(compid);
                            }
                            chain.push(compid);
                            tempGroup.push(compid);
                            instIndex += 1;
                        } else {
                            for (const key in allGroups) {
                                try {
                                    if (allGroups.hasOwnProperty(key)) {
                                        if (allGroups[key].includes(compid)) {
                                            allGroups[key] = allGroups[key].concat(
                                                allGroups[instGroupIndx]
                                            );
                                            delete allGroups[instGroupIndx];
                                            instGroupIndx -= 1;
                                        }
                                    }
                                } catch (error) {}
                            }
                        }
                        getChildrenChain(child[1]);
                    });
                } else if (
                    RetrievedData.parent_child_matrix[compid].length == 0 &&
                    !chain.includes(compid)
                ) {
                    chain.push(compid);
                    try {
                        allGroups[instGroupIndx].push(compid);
                    } catch {
                        console.log('hoppa');
                    }
                    instIndex += 1;
                    instGroupIndx += 1;
                }
            }

            function iterateRoots() {
                for (const key in RetrievedData.root_components) {
                    if (RetrievedData.root_components.hasOwnProperty(key)) {
                        const element = RetrievedData.root_components[key];
                        if (element == 'root') {
                            currentObj = selectComp(key);
                            if (currentObj != null) {
                                getChildrenChain(key);
                            }
                        }
                    }
                }
            }

            iterateRoots();
        </script>

        <script>
            htmlContents = ``;

            groupLength = 0;

            for (const key in allGroups) {
                if (allGroups.hasOwnProperty(key)) {
                    groupLength += 1;
                }
            }
            for (const key in allGroups) {
                if (allGroups.hasOwnProperty(key)) {
                    const element = allGroups[key];
                    if (groupLength > 1) {
                        htmlContents +=
                            `<div id="group_division" style="width:` +
                            100 / groupLength +
                            `%;float:left">`;
                    } else {
                        htmlContents +=
                            `<div id="group_division" style="width:` + 100 / groupLength + `%">`;
                    }

                    htmlContents += `<div id="group_division_container">`;
                    htmlContents += `<div id="group_division_header">`;
                    htmlContents += `<div id="boardgroupControlPanel"><i class="fas fa-play" style="width: 55px;text-align: center;border: 1px solid gray;padding: 5px;border-radius: 5px;"></i></div> `;
                    htmlContents += `</div>`;

                    htmlContents += `<div id="group_division_body">`;

                    allGroups[key].forEach(element => {
                        currentObj = selectComp(element);

                        if (currentObj != null) {
                            if (currentObj['type'] == 'string') {
                                if (currentObj['outputs'][0]['type'] == 'plot') {
                                    htmlContents +=
                                        `<div class="input-group-text">` +
                                        currentObj['Name'] +
                                        `</div>
                                        <div id="plot_area` +
                                        currentObj.GUID +
                                        `" style="width:100%; height:100%;"></div>`;
                                } else if (currentObj['inputs'][0]['type'] == 'html') {
                                    htmlContents +=
                                        `<div class="input-group-text">` +
                                        currentObj['Name'] +
                                        `</div>` +
                                        currentObj['inputs'][0]['value'];
                                } else {
                                    htmlContents +=
                                        `
                        <div class="input-group">
                        <div class="input-group-prepend">
                            <div class="input-group-text">` +
                                        currentObj['Name'] +
                                        `</div>
                        </div>
                        <textarea class="boardgroup_textarea" aria-label="With textarea">` +
                                        currentObj['inputs'][0]['value'] +
                                        `</textarea>
                        </div>`;
                                }
                            } else if (currentObj['type'] == 'optionList') {
                                htmlContents += `
                    <select>
                        `;
                                for (const option in currentObj['optionListValues']) {
                                    if (currentObj['optionListValues'].hasOwnProperty(option)) {
                                        const element2 = currentObj['optionListValues'][option];
                                        htmlContents +=
                                            `<option value="` +
                                            element2 +
                                            `">` +
                                            option +
                                            `</option>`;
                                    }
                                }
                                htmlContents += `
                    </select>
                    `;
                            } else if (currentObj['type'] == 'component') {
                                htmlContents +=
                                    `<div id="componentBox" style="background-color:` +
                                    currentObj.fill +
                                    `">` +
                                    currentObj.Name +
                                    `</div>`;
                            }

                            htmlContents += `<div id="arrowDown"><i class="fas fa-arrow-down"></i></div>`;
                        }
                    });

                    htmlContents += `</div>`;
                    htmlContents += `</div>`;
                    htmlContents += `</div>`;
                }
            }

            {
            }

            $('div.container-fluid').html(htmlContents);

            for (const key in allGroups) {
                if (allGroups.hasOwnProperty(key)) {
                    const element = allGroups[key];

                    allGroups[key].forEach(element => {
                        currentObj = selectComp(element);
                        if (currentObj != null) {
                            if (currentObj['type'] == 'string') {
                                if (currentObj['outputs'][0]['type'] == 'plot') {
                                    drawPlotBoardComponent(
                                        JSON.parse(currentObj.inputs[0].value),
                                        currentObj
                                    );
                                }
                            }
                        }
                    });
                }
            }
            //
        </script>
    </body>
</html>
